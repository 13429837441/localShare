<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å±€åŸŸç½‘æ–‡ä»¶äº’ä¼ å·¥å…·</title>
  <!-- Dropzone CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='lib/dropzone.min.css') }}" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
  
  <!-- æ·»åŠ Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#ace9e5',
                    secondary: '#3b82f6',
                    accent: '#60a5fa',
                    light: '#dbeafe',
                    dark: '#1e3a8a'
                }
            }
        }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
        .floating-button {
            transition: all 0.3s ease;
        }
        .floating-button:hover {
            transform: scale(1.1);
        }
        .floating-button.active {
            transform: rotate(90deg);
        }
    }
  </style>
  
  <style>

  </style>
</head>
<body>

<div class="container">

  <header>
    <h1><i class="fas fa-share-alt"></i> å±€åŸŸç½‘æ–‡ä»¶äº’ä¼ </h1>
    <p>æ‰«æäºŒç»´ç ï¼Œæ‰‹æœºå¿«é€Ÿä¸Šä¼ /ä¸‹è½½</p>
  </header>

  <!-- äºŒç»´ç åŒºåŸŸ -->
  <div class="qrcode-box">
    <div id="qrcode"></div>
    <p>ğŸ“± æ‰«ç è®¿é—®æœ¬é¡µ</p>
  </div>

  <!-- æ‹–æ‹½ä¸Šä¼ åŒº -->
  <form action="/upload" class="dropzone" id="myDropzone"></form>

  <!-- æ–‡ä»¶åˆ—è¡¨ -->
  <section class="file-list">
    <h2><i class="fas fa-folder-open">æ–‡ä»¶åˆ—è¡¨</i>
      <form action="/clear" method="post">
        <button type="submit" class="btn-clear shadow-sm btn-outline-danger" onclick="return confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶å—ï¼Ÿ')">ğŸ—‘ï¸ ä¸€é”®æ¸…ç©º</button>
      </form>
    </h2>
    <div id="fileTableBody">
      {% if files %}
        <ul>
          {% for file in files %}
            <li>
              <div class="file-item">
                <div class="file-icon">
                  <i class="far {{ file.icon }} icon-large me-3"></i>
                </div>
                <div class="file-info">
                  <a href="{{ file.url }}" download>{{ file.name }}</a>
                  <small>{{ file.size }} Â· {{ file.mtime }}</small>
                </div>
                <a href="{{ file.url }}" class="btn-download" download>
                  <i class="fas fa-download"></i>
                </a>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="empty">æš‚æ— æ–‡ä»¶</p>
      {% endif %}
    </div>
  </section>
</div>

<!-- æ¶ˆæ¯æ‚¬æµ®çƒ -->
<div class="fixed bottom-5 right-5 z-50">
    <button id="message-button" class="floating-button bg-primary hover:#ace9e5 text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center">
        <i class="fas fa-comments text-xl"></i>
        <span id="message-badge" class="notification-badge hidden">0</span>
    </button>
    
    <!-- æ¶ˆæ¯é¢æ¿ -->
    <div id="message-panel" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-xl shadow-2xl overflow-hidden">
        <div class="bg-primary text-white p-4 flex justify-between items-center">
            <h3 class="font-bold">å®æ—¶æ¶ˆæ¯</h3>
            <button id="close-message-panel" class="text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="message-container" class="message-container p-4 bg-gray-50">
            <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="p-4 border-t">
            <form id="message-form" class="flex">
                <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 border border-gray-300 rounded-l-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary">
                <button type="submit" class="bg-primary hover:#ace9e5 text-white px-4 py-2 rounded-r-md transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- é€šçŸ¥æç¤º -->
<div id="notification" class="fixed top-4 right-4 bg-white rounded-lg shadow-lg p-4 transform translate-x-full transition-transform duration-300 z-50 max-w-sm">
    <div class="flex items-start">
        <div id="notification-icon" class="flex-shrink-0 text-green-500">
            <i class="fas fa-check-circle text-xl"></i>
        </div>
        <div class="ml-3 flex-1">
            <p id="notification-title" class="text-sm font-medium text-gray-900">æ“ä½œæˆåŠŸ</p>
            <p id="notification-message" class="mt-1 text-sm text-gray-500">æ–‡ä»¶ä¸Šä¼ æˆåŠŸ</p>
        </div>
        <button id="close-notification" class="ml-4 text-gray-400 hover:text-gray-500">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- QRCode.js -->
<script src="{{ url_for('static', filename='lib/qrcode.min.js') }}"></script>
<!-- Dropzone JS -->
<script src="{{ url_for('static', filename='lib/dropzone.min.js') }}"></script>
<!-- socketIO JS -->
<script src="{{ url_for('static', filename='lib/socket.io.min.js') }}"></script>
<script>
  // ç”ŸæˆäºŒç»´ç 
  new QRCode(document.getElementById("qrcode"), {
    text: "{{ server_url }}",
    width: 180,
    height: 180
  });

  // Dropzone é…ç½®
  Dropzone.options.myDropzone = {
    paramName: "file",
    maxFilesize: 1024, // MB
    timeout: 600000,
    dictDefaultMessage: "ğŸ“ æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶",
    dictFallbackMessage: "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‹–æ‹½ä¸Šä¼ ",
    dictInvalidFileType: "ä¸æ”¯æŒæ­¤æ–‡ä»¶ç±»å‹",
    accept: function(file, done) {
      done();
    },
    init: function() {
      this.on("success", function(file, response) {
        console.log("ä¸Šä¼ æˆåŠŸ:", response);
        setTimeout(() => location.reload(), 1000);
      });
      this.on("error", function(file, message) {
        alert("ä¸Šä¼ å¤±è´¥: " + message);
      });
    }
  };

  // åˆå§‹åŒ–SocketIO
  var socket = io();
  var clientId = ''; // å­˜å‚¨å®¢æˆ·ç«¯ID
  
  // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
  document.addEventListener('DOMContentLoaded', function() {
      // å½“æœ‰æ–°æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œé€šçŸ¥é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯åˆ·æ–°åˆ—è¡¨
      socket.on('file_updated', function() {
        refreshFileList();
      });
      
      // è¿æ¥æˆåŠŸï¼Œè·å–å®¢æˆ·ç«¯ID
      socket.on('connection_response', function(data) {
        console.log('Connected to server:', data.message);
        clientId = data.client_id;
        console.log('Client ID:', clientId);
      });
      
      // åˆå§‹åŒ–æ¶ˆæ¯é¢æ¿
      initMessagePanel();
      
      // åˆå§‹åŒ–é€šçŸ¥
      initNotification();
  });

  // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
  function refreshFileList() {
      fetch('/api/files')
          .then(response => response.json())
          .then(data => {
              var tableBody = document.getElementById('fileTableBody');
              var fileInnerHTML = '';
              tableBody.innerHTML = '';

              if (data.files.length === 0) {
                  tableBody.innerHTML = `
                    <p class="empty">æš‚æ— æ–‡ä»¶</p>
                  `;
                  return;
              }

              fileInnerHTML += '<ul>';
              data.files.forEach(file => {
                fileInnerHTML += `
                  <li>
                    <div class="file-item">
                      <div class="file-icon">
                        <i class="far ${ file.icon } icon-large me-3"></i>
                      </div>
                      <div class="file-info">
                        <a href="${ file.url }" download>${ file.name }</a>
                        <small>${ file.size } Â· ${ file.mtime }</small>
                      </div>
                      <a href="${ file.url }" class="btn-download" download>
                        <i class="fas fa-download"></i>
                      </a>
                    </div>
                  </li>
                `;
              });
              fileInnerHTML += '</ul>';
              tableBody.innerHTML = fileInnerHTML;
          });
  }
  
  // æ¶ˆæ¯é¢æ¿ç›¸å…³å˜é‡
  let unreadMessages = 0;
  
  // åˆå§‹åŒ–æ¶ˆæ¯é¢æ¿
  function initMessagePanel() {
      const messageButton = document.getElementById('message-button');
      const messagePanel = document.getElementById('message-panel');
      const closeMessagePanel = document.getElementById('close-message-panel');
      const messageForm = document.getElementById('message-form');
      const messageInput = document.getElementById('message-input');
      
      // æ‰“å¼€/å…³é—­æ¶ˆæ¯é¢æ¿
      messageButton.addEventListener('click', function() {
          messagePanel.classList.toggle('hidden');
          messageButton.classList.toggle('active');
          
          // å¦‚æœæ‰“å¼€æ¶ˆæ¯é¢æ¿ï¼Œé‡ç½®æœªè¯»æ¶ˆæ¯è®¡æ•°
          if (!messagePanel.classList.contains('hidden')) {
              unreadMessages = 0;
              updateMessageBadge();
          }
      });
      
      // å…³é—­æ¶ˆæ¯é¢æ¿
      closeMessagePanel.addEventListener('click', function() {
          messagePanel.classList.add('hidden');
          messageButton.classList.remove('active');
      });
      
      // å‘é€æ¶ˆæ¯
      messageForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const message = messageInput.value.trim();
          
          if (message) {
              // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨ï¼ŒåŒ…å«å®¢æˆ·ç«¯ID
              socket.emit('send_message', { 
                  message: message,
                  client_id: clientId
              });
              
              // åœ¨æœ¬åœ°åœ°æ˜¾ç¤ºæ¶ˆæ¯
              const timestamp = new Date().toLocaleString();
              addMessage(message, timestamp, true);
              
              // æ¸…ç©ºè¾“å…¥æ¡†
              messageInput.value = '';
          }
      });
      
      // ç›‘å¬æ–°æ¶ˆæ¯
      socket.on('new_message', function(data) {
          console.log('New message:', data);
          
          // å¦‚æœæ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼Œåˆ™å¿½ç•¥
          if (data.client_id === clientId) {
              console.log('Ignoring own message');
              return;
          }
          
          // æ˜¾ç¤ºæ”¶åˆ°çš„æ¶ˆæ¯
          addMessage(data.message, data.timestamp, false);
          
          // å¦‚æœæ¶ˆæ¯é¢æ¿æœªæ‰“å¼€ï¼Œæ˜¾ç¤ºæœªè¯»æ¶ˆæ¯å¾½ç« 
          if (messagePanel.classList.contains('hidden')) {
              unreadMessages++;
              updateMessageBadge();
              showNotification('info', 'æ–°æ¶ˆæ¯', 'æ”¶åˆ°ä¸€æ¡æ–°æ¶ˆæ¯');
          }
      });
  }
  
  // æ·»åŠ æ¶ˆæ¯åˆ°æ¶ˆæ¯é¢æ¿
  function addMessage(message, timestamp, isSent) {
      const messageContainer = document.getElementById('message-container');
      const messageBubble = document.createElement('div');
      const messageClass = isSent ? 'sent' : 'received';
      
      messageBubble.className = `message-bubble ${messageClass}`;
      messageBubble.innerHTML = `
          <p class="text-sm text-break">${message}</p>
          <p class="text-xs mt-1 opacity-70 text-right">${timestamp}</p>
      `;
      
      messageContainer.appendChild(messageBubble);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      messageContainer.scrollTop = messageContainer.scrollHeight;
  }
  
  // æ›´æ–°æ¶ˆæ¯å¾½ç« 
  function updateMessageBadge() {
      const messageBadge = document.getElementById('message-badge');
      
      if (unreadMessages > 0) {
          messageBadge.textContent = unreadMessages;
          messageBadge.classList.remove('hidden');
      } else {
          messageBadge.classList.add('hidden');
      }
  }
  
  // åˆå§‹åŒ–é€šçŸ¥
  function initNotification() {
      const notification = document.getElementById('notification');
      const closeNotification = document.getElementById('close-notification');
      
      closeNotification.addEventListener('click', function() {
          hideNotification();
      });
      
      // ç‚¹å‡»é€šçŸ¥å¤–éƒ¨å…³é—­
      notification.addEventListener('click', function(e) {
          if (e.target === notification) {
              hideNotification();
          }
      });
  }
  
  // æ˜¾ç¤ºé€šçŸ¥
  function showNotification(type, title, message) {
      const notification = document.getElementById('notification');
      const notificationTitle = document.getElementById('notification-title');
      const notificationMessage = document.getElementById('notification-message');
      const notificationIcon = document.getElementById('notification-icon');
      
      // è®¾ç½®é€šçŸ¥ç±»å‹
      notificationIcon.className = 'flex-shrink-0';
      
      if (type === 'success') {
          notificationIcon.innerHTML = '<i class="fas fa-check-circle text-xl text-green-500"></i>';
      } else if (type === 'error') {
          notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle text-xl text-red-500"></i>';
      } else if (type === 'info') {
          notificationIcon.innerHTML = '<i class="fas fa-info-circle text-xl text-blue-500"></i>';
      }
      
      // è®¾ç½®é€šçŸ¥å†…å®¹
      notificationTitle.textContent = title;
      notificationMessage.textContent = message;
      
      // æ˜¾ç¤ºé€šçŸ¥
      notification.classList.remove('translate-x-full');
      
      // 3ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
          hideNotification();
      }, 3000);
  }
  
  // éšè—é€šçŸ¥
  function hideNotification() {
      const notification = document.getElementById('notification');
      notification.classList.add('translate-x-full');
  }
</script>

</body>
</html>
